<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN" "http://www.w3.org/TR/html4/loose.dtd">
<html>
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8" >
<title>LCUI &#8250; 动态 &#8250; 开发日志</title>
<link rel="icon" href="lc-soft.png" type="image/png">
<meta name="keywords" content="GUI,LCSoft,LCDT,LCUI,Embedded,linux,liuchao,opensource,freesoft,C" >
<meta name="description" content="LCUI 0.12.6 开发日志" >
<meta name="robots" content="all" >
<meta name="author" content="LC-Soft" >
<link type="text/css" rel="stylesheet" href="../files/css/main.css"> 
<link type="text/css" rel="stylesheet" href="../files/css/dev_log.css"> 
</head>
  <body style="margin-top: 100px;"class="my_body"> 
    <script type="text/javascript" src="../files/js/jquery-1.8.1.min.js"></script>
    <script type="text/javascript" src="../files/js/ms-script.jsx"></script>
    <script type="text/javascript" src="../files/js/menu-effect.js"></script>
    <script type="text/javascript" src="../files/js/titlemenu.zh-cn.js"></script> 
    <script type="text/javascript" src="../files/audiojs/float_musicplayer.js"></script> 
	
	<div style="padding-top: 30px;"> 

    <!-- 上面是标题栏区域 --> 
<div class="entry-content">
<center><h1>LCUI 0.12.6</h1></center>
<hr>
		<h2>2012-9-12</h2>
<p>打算将LCUI的widget属性命名方式，搞成html 的&nbsp;CSS 标签属性那样，当然，这会应用在widget 的C++类上。</p>
<h2>2012-9-13</h2>
<p>为了完善按键输入，研究linux/input.h中的函数声明。</p>
<p>使用 cat /proc/bus/input/devices 可以看到每个eventX是什么设备的事件，电源键都有！</p>
<p>网上找了一下，没看到几个结果是说读按键输入，大多是模拟按键输入，写按键输入事件，于是，将“写数据”改成“读数据”，测试的设备是/dev/input/event3，结果无任何效果；加了printf函数打印信息后，有输出了，个人认为是输入缓冲的关系，改用fflush函数清空输入缓冲，结果正常。之后，又用了LCUI自带的Set_Raw函数设置终端为无缓冲模式，fflush函数就不要了，再次测试，结果正常。</p>
<p>效果比较满意，但放到学习机上测试时，发现学习机用的是/dev/input/event0，这没什么大碍，可是，无法判断某个为“按住”状态，只有“按下”和“释放”，按住某个键时，结果表明，程序把“按住”状态识别成了“按下”和“释放”这两个状态。</p>
<p>&nbsp;</p>
<h2>2012-9-14</h2>
<p>文本框设计方案：<br>
文本框要支持不同大小、不同字体、不同颜色的文字显示。<br>
用一个结构体保存字符码以及指向该字符属性的指针。<br>
字符属性包括：颜色、背景色、字体类型、字体大小、粗体、斜体、下划线。</p>
<p>考虑到代码编辑器会用到文本框，那么，文本框要有一个记录能够保存哪些字符串要使用什么颜色、什么字体、什么背景色等数据。<br>
是否自动换行。<br>
用一个结构体记录光标的相对位置、在字符串中的位置、长度、闪烁频率，增删文字时，以光标位置为基础，对该位置的字符进行增删，之后会自动调整光标位置。<br>
文本框能够响应鼠标事件。</p>
<p>需要记录每一行文字的高度， 因为这一行的文字的大小可能不统一。</p>
<p>&nbsp;</p>
<h2>2012-9-15</h2>
<p>感觉文本框用链表式队列来储存源文本好一些，用数组式队列的话，只要增删一个字，都要要移动这个字后面的所有字。</p>
<p>正在实现TextBox部件的样式标签处理功能， 之前的Label部件，只支持&lt;color&gt;标签来设置文本颜色，而TextBox部件不只是支持这个标签，还有&lt;size&gt;, &lt;family&gt;, &lt;style&gt;, &lt;weight&gt;, &lt;decoration&gt;这5个标签，在TextBox部件完成后，Label部件可能需要进行一次改写。</p>
<h2>2012-9-17</h2>
<p>现在新增功能模块，大致流程就是这样： 先设计好数据结构，然后设计相关函数接口，最后就是写函数的实现，在写函数的实现时，有时灵感来了，就会新增几个函数接口，修改一下数据结构。</p>
<p>已经将开发中的TextBox部件的源代码上传至github.com，<a href="https://github.com/lc-soft/LCUI/commit/48f37be24b64782dd54f33bb0528bd04a748d196#L12R0" target="_blank">可到这查看</a>。</p>
<h2>2012-9-19</h2>
<p>为队列添加链表式储存模式，可以在数组式和链表式这两种模式之间进行选择，各有各的特点。</p>
<p>代码添加完成，函数接口名没变，有的函数的参数就是多加了个const ，<a href="https://github.com/lc-soft/LCUI/commit/4a8be9555e36e64047eec3ef40d0f16235a61c47" target="_blank">请看这里</a>，还有BUG，等待修复。</p>
<p>&nbsp;</p>
<h2>2012-9-20</h2>
<p>经过一番调试后，这次修改的队列处理已经能够正常工作了，<a href="https://github.com/lc-soft/LCUI/commit/4006c09229744c3905ce56bf48b159d390e57ffa" target="_blank">可看这里</a>。</p>
<p>调试的方法，主要是分析出错的函数，然后用修改前备份的函数代替它，测试如果没问题，那么就是这个函数有问题，然后将新函数与旧函数进行对比，看新函数哪里有问题，有则进行修正。最后也就是用测试程序测试队列的主要功能是否异常。</p>
<p>队列的数据删除函数出了点问题，需要进行修复。</p>
<p><a href="https://github.com/lc-soft/LCUI/commit/da7ee17af196abf02fadcfd8da5f1f7a53673b2c" target="_blank">已经进行修复</a>。只是修改了一下数据有效性检测，无效则退出函数，居然会出错，只好再改一下。</p>
<p>准备继续实现文本框。。。</p>
<p>&nbsp;</p>
<p>又折腾了一下主页，项目主页在windows平台上，用IE9和Chrome浏览器浏览时，可以在音乐播放器中播放音乐，但改用FireFox 和 Opera浏览器后，只能看，不能用。。。</p>
<p>本来是怀疑我修改的网页代码的问题，又重新去audiojs官方网站下载audiojs，解压后用浏览器打开里面的index.html，结果，问题依旧，FireFox 和 Opera浏览器不能播放音乐；不知为什么，同样是一张网页，在它的官方网站上可以正常播放音乐，下载到本地的却不能，难道作者没有测试压缩包里面的文件？</p>
<p>IE浏览器和Chrome浏览器显示的效果不一样，比如音乐播放器：</p>
<p><a href="http://lcui.org/files/images/devlog/musicplayer_chrome.png"><img class="alignnone" title="Chrome测试效果图" src="http://lcui.org/files/images/devlog/musicplayer_chrome.png" alt="" width="349" height="233"></a><a href="http://lcui.org/files/images/devlog/musicplayer_IE9.png"><img class="alignnone" title="IE9测试效果图" src="http://lcui.org/files/images/devlog/musicplayer_IE9.png" alt="" width="339" height="223"></a></p>
<p>font-family是monospace，Chrome里显示得很亮很细，而IE9里，有点暗且有点宽；&lt;li&gt;标签的效果也有点差异，对于标号和条目间隔，IE9比Chrome更宽一些。之前再IE9里测试，进度条边上显示时间没有了，个人猜测是由于排版的问题，使用IE自带的工具查看元素，发现时间显示在下面去了，调整padding和margin后，终于显示出来了。</p>
<p>在测试网页效果的过程中，发现FireFox的“查看元素”功能的3D视图不错，可以看到各个区块的层叠顺序。</p>
<div class="wp-caption alignnone" style="width: 842px"><a href="http://lcui.org/files/images/devlog/homepage-3Dview.png"><img title="FireFox的3D视图效果" src="http://lcui.org/files/images/devlog/homepage-3Dview.png" alt="" ></a><p class="wp-caption-text">FireFox的3D视图效果</p></div>
<p>&nbsp;</p>
<p>主页上的那个按钮，在webkit引擎的浏览器中显示的效果正常，其它浏览器中却不正常，如下图所示：</p>
<p><a href="http://lcui.org/files/images/devlog/btn_chrome.png"><img class="alignnone" title="webkit引擎的浏览器中显示的按钮" src="http://lcui.org/files/images/devlog/btn_chrome.png" alt="" width="207" height="217"></a><a href="http://lcui.org/files/images/devlog/btn_IE9.png"><img class="alignnone" title="非webkit引擎的浏览器显示的按钮" src="http://lcui.org/files/images/devlog/btn_IE9.png" alt="" width="204" height="218"></a></p>
<p>按钮使用了linear-gradient，也就是CSS3的线性渐变效果，发现这属性不在所有浏览器中通用，Opera里要用-o-linear-gradient，FireFox里用-moz-linear-gradient，Chrome里用-webkit-linear-gradient，IE不支持，需要用其它方法，不只是这一个，比如transition，它用于实现过渡效果，div的移动就是用它实现的。</p>
<p>进了兔斯基的网站，然后，又修改了一下自己的项目主页。。。</p>
<p><a href="http://www.lcui.org/files/images/devlog/homepage-catch.jpg"><img class="alignnone" title="主页截图" src="http://www.lcui.org/files/images/devlog/homepage-catch.jpg" alt="" width="450" height="219"></a></p>
<p>&nbsp;</p>
<h2>2012-9-21</h2>
<p>修改中文文档的文件名为英文，包含汉字的文件名在打包压缩后，在其它平台上解压会出现乱码，比如在linux下打包压缩，在windows下解压，中文名乱码，同样，在windows下打包压缩，在linux下解压也会出现这问题。</p>
<p>对于文本框，貌似需要用一个库，记录字体文件句柄与字体族名，使用&lt;family&gt;标签指定文本框中某段文本的字体族时，就根据这个字体族名在库中查找与之对应的字体文件句柄，找到后，就使用这个句柄，获取字形。</p>
<h2>2012-9-22</h2>
<p>测试文本框时，发现队列处理上出了毛病，数据存入队列后，再取出来，内容一样，经过调试后发现，本来是用memcpy( p-&gt;data, data, queue-&gt;element_size ); 我却写成了：memcpy( p-&gt;data, data, &nbsp;sizeof(queue-&gt;element_size) ); ，怪不得数据前半部分一样，后半部分异常。</p>
<p>看样子，代码还是需要进行一次规范化，等以后有时间再说。</p>
<p>文本框的绘制功能已经完成，中途发现图形处理方面的小BUG，对图形进行“写”操作前，没有使用“写”锁锁定数据，操作后没有进行解锁，也无法更新图形相关属性，导致图形处理时进行了错误的判断，最终使绘制的文本框无法显示，<a href="https://github.com/lc-soft/LCUI/commit/075c88e6ca8946021bad2f38f15e88bd58b09496" target="_blank">点击这里可查看被改动的代码</a>。</p>
<p>以下是文本框的截图：</p>
<p><a href="http://www.lcui.org/files/images/devlog/2012-09-22-17-08-40.png"><img class="alignnone" title="文本框" src="http://www.lcui.org/files/images/devlog/2012-09-22-17-08-40.png" alt="" width="320" height="240"></a></p>
<p>只实现了文本位图的绘制，文本输入、自动换行、光标、滚动条等还未添加，但测试时发现了一些问题：</p>
<p><a href="http://www.lcui.org/files/images/devlog/2012-09-22-17-08-50.png"><img class="alignnone" title="局部刷新异常" src="http://www.lcui.org/files/images/devlog/2012-09-22-17-08-50.png" alt="" width="320" height="240"></a></p>
<p>按钮本该整体刷新的，结果没刷新，只是在鼠标移动时刷新了鼠标范围内的图形。</p>
<p><a href="http://www.lcui.org/files/images/devlog/2012-09-22-17-09-06.png"><img class="alignnone" title="少了几个字" src="http://www.lcui.org/files/images/devlog/2012-09-22-17-09-06.png" alt="" width="320" height="240"></a></p>
<p><a href="http://www.lcui.org/files/images/devlog/2012-09-22-17-09-14.png"><img class="alignnone" title="少了很多字" src="http://www.lcui.org/files/images/devlog/2012-09-22-17-09-14.png" alt="" width="320" height="240"></a></p>
<p>字数异常，连标题栏上的字都出问题了。</p>
<p>个人猜测是实现文本框的代码中有数据访问越界，使LCUI其它的功能发生异常，之前在测试PictureBox部件时出现过类似问题。</p>
<p>经过测试，发现把TextBox_Get_Char_Bitmap ( &amp;char_data );这行注释掉后，没有上述问题，往复运行多次测试程序，无异常，需要看看字体位图的获取上有什么问题。</p>
<p>&nbsp;</p>
<h2>2012-9-23</h2>
<p>折腾了一天，为了移植些软件到目标设备中，configure运行到最后，正要创建config.h文件，却出现以下信息：</p>
<p>config.status: creating config.h<br>
config.status: config.h is unchanged</p>
<p>libtool，libiconv，libjpeg这三个的源代码也是这样，搞得在编译时因找不到config.h文件而报错；<br>
直接手动创建config.h文件话，对于libjpeg还可以，但对于其它的就不行了，config.h中没有定义相应宏，源文件中又用到了这些宏。</p>
<p>还好我的lcui不需要config.h，补全了依赖库后顺利安装。</p>
<p>在我修改config.status里的代码后，才能正常生成config.h。</p>
<p>由于目标设备的root分区可用空间少，只有几百MB，剩余空间不足10MB，于是我创建了个root.ext2文件，512MB大小，格式化成ext2，然后挂载了它；<br>
在里面创建了usr文件夹，把同架构的另一个设备（学习机）里的include，share等文件夹复制到了usr文件夹里，usr/include等文件夹也挂载到了/usr/下。</p>
<p>编译freetype2时连configure都不能运行，直接报错说缺少Make程序或支持环境。</p>
<p>运行autogen.sh也出错，好像缺少了什么。</p>
<p>搞得最后交叉编译，由于依赖关系，去编译GNU Guile，而Guile依赖libgmp，&nbsp;libiconv，&nbsp;libintl，libltdl，libunistring，libgc，libffi，补充了些依赖软件后，configure还是不通过，于是就放弃了。</p>
<p>&nbsp;</p>
<h2>2012-9-24</h2>
<p>在看了GNU主页上的一些文章后，就修改LCUI主页，添加些内容。</p>
<p>在设备上测试LCUI，显示器是16位，窗口移动后的残余区域图形显示异常，经分析发现是拷贝的屏幕图形数据有问题，屏幕是16位的，那么像素点的RGB色彩值就是以16位表示的，而LCUI却把16位当24位来处理，导致图形显示异常。</p>
<p>测试照片查看器，发现Load_Image()函数有问题。LCUI退出时出现段错误。</p>
<p>指针间相减，不需要再除以sizeof(指针类型)，比如:</p>
<p>wchar_t src[10]=L”abcdeg”, *p, *q;<br>
p = src;<br>
q = &amp;src[5];</p>
<p>q-p就等于5，也就是相差的元素个数，之前还一直以为是直接拿指针内的地址编号相减。</p>
<p>现在又纠结一个问题：</p>
<p>往文本框里添加一段文本：&lt;color=255,0,0&gt;红色文字&lt;/color&gt;普通文字</p>
<p>然后呢，插入一段文本，变为：&lt;color=255,0,0&gt;红色文字 新增文字&lt;/color&gt;普通文字</p>
<p>该如何处理呢？这彩色文字，目前的处理方式只是在添加它时处理新文本的字体样式，处理结果就是新增文字不会变成红色，如果是每次更新文本时统一处理这些文字的样式，虽然能达到效果，但是，如果有10000行以上的文字呢？那不就是每修改一个字都要遍历一次呢？字越多，耗时越长，会卡顿。</p>
<p>先暂时不考虑字体样式的处理，把基本功能完成后再考虑。</p>
<p>&nbsp;</p>
<h2>2012-9-26</h2>
<p>在CSDN上看了某网友的文章，有这么一段话：“unix有三个基本思想：1.程序只做一件事情；2.程序之间能协同工作；3，程序处理文本流，因为它是一个通用的接口。”，再看看我之前写的代码，的确很乱，LCUI的源代码需要进行重新规划；</p>
<p>之前就想好了一些，LCUI的源码目录结构大致是这样的：<br>
/<br>
../src/<br>
../…/bmp/ &nbsp;(图片文件的读取/写入)<br>
../…/draw/ （图形绘制）<br>
../…/font/ （字体处理）<br>
../…/gui/ &nbsp;（一些现成的图形界面，例如MessageBox、颜色选择、字体选择等）<br>
../…/input/ （处理输入设备输入的数据，例如鼠标、触屏、键盘等）<br>
../…/loadso/ （动态库的操作）<br>
../…/…../dlopen.c<br>
../…/output/ （数据输出，一般是图形数据）<br>
../…/……/framebuffer.c （通过帧缓冲显示图形）<br>
../…/……/x11.c （通过X Window系统显示图形）<br>
../…/thread/ （线程支持）<br>
../…/……/pthread.c<br>
../…/widget/ （GUI部件）</p>
<p>对于LCUI程序，如果在X11环境下运行，那么，就使用X11进行图形输出，也就是创建个窗口，把图形数据输出到窗口里；<br>
如果是在字符控制台模式下运行，就直接使用FrameBuffer。<br>
那么，LCUI程序如何知道自己是在哪种环境下运行呢？这个可以参考SDL的源代码。</p>
<p>widget的属性，参考html标签的css属性，添加padding，margin，position，x-index，display等属性，省得自己纠结属性的命名了，这些属性所产生的效果我也知道，就算不知道可以写代码用浏览器测试，所以实现起来不是很难。</p>
<p>&nbsp;</p>
<h2>2012-9-27</h2>
<p>工作量比较大，需要分割源文件，整理源代码。先不对源代码进行修改，以免测试时出现问题。</p>
<h2>2012-9-28</h2>
<p>源代码分割已经基本完成，剩下的就是整理头文件，完善细节。</p>
<p>头文件已经整理完成，测试程序运行时还有异常，需要解决。</p>
<p>&nbsp;</p>
<h2>2012-9-30</h2>
<p><a href="https://github.com/lc-soft/LCUI/commit/db1d4fe6436751e16e46275ab7860df4a4d5a607" target="_blank">解决了字体位图异常的问题</a>，个人估计是用了FontBMP_Free()函数的缘故，把野指针释放了，结果获取字体位图时就出现问题了。修改代码后，多次测试，没异常。</p>
<p>需要整理一下思路，毕竟有一段时间没搞文本框了，现在不知从何开始。</p>
<p>&lt;color&gt;标签应该要支持#abc,#fb89cc等之类的色彩表示。</p>
<h2></h2>
<h2>2012-10-1</h2>
<p>正调整字体位图的处理功能。</p>
<h2>2012-10-2</h2>
<p>目前正在纠结FreeType2，又看了一下中译版的FreeType2文档，发现除了glyph-&gt;bitmap_top，还有个glyph-&gt;bitmap_left，怪不得中文的逗号和英文的逗号占的宽度都一样，原来是没有利用glyph-&gt;left的值来调整字形的距离。</p>
<h2>2012-10-3</h2>
<p>先暂时禁用Label部件的绘制功能，等TextBox部件的文本绘制功能完成后，再让Label部件使用TextBox的文本绘制功能。</p>
<p>文本框分成两个图层：背景 + 文本，这样，每次绘制文本时，就不必重绘背景了。</p>
<p>打算让LCUI能够在系统目录中扫描字体文件，比如Ubuntu，它的字体文件在/usr/share/fonts/ 目录下，那么，就遍历文件目录，找个合适的字体。</p>
<p>Label和TextBox部件都是显示文本的，只不过，后者可以编辑文本内容，考虑到windows上的Label控件内的文本可以选中和复制，那么就让Label和TextBox部件使用同一个文本位图处理模块。</p>
<h2>2012-10-4</h2>
<p>使用这段文本：&lt;color=#FF0000&gt;1&lt;color=#0000FF&gt;2&lt;/color&gt;3&lt;/color&gt;4</p>
<p>理论上 1 和 3会变成红色， 2 变成蓝色，而4是默认的黑色，测试结果只有1和2变了色，34是默认的黑色，看样子是处理&lt;/color&gt;这标签是出了问题。</p>
<p>问题已解决，原因是这个函数：wchar_t *get_style_endtag ( wchar_t *str, char *out_tag_name ); 调用它后，没有判断返回值是否为NULL，直接用strcmp对比&lt;/color&gt;和out_tag_name，而get_style_endtag在返回NULL前又没有清空字符out_tag_name的内容，out_tag_name内容无变化，导致误删标签数据。</p>
<p><a href="http://www.lcui.org/files/images/devlog/2012-10-04-15-28-36.png"><img class="alignnone" title="文本框效果图" src="http://www.lcui.org/files/images/devlog/2012-10-04-15-28-36.png" alt="" width="320" height="240"></a></p>
<p>接下来就是光标显示了，光标能够闪烁，貌似需要一个定时器，每隔M时间显示光标，每隔N时间隐藏光标；</p>
<p>光标定位是个问题。。。</p>
<p>将TextBox部件作为文本图层的容器，而文本图层就作为光标（一个widget）的容器。</p>
<p>那个文本图层该取什么名字呢？Text Surface？Text Layer？纠结中。。。</p>
<p>&nbsp;</p>
<h2>2012-10-5</h2>
<p>文本框里的文本位图处理的代码划分至font目录里，这属于文字+字体位图处理。</p>
<p>正添加一些函数。</p>
<p>正在修改Label部件的源代码，原有的彩色文本绘制以及&lt;color&gt;标签处理的几百行代码就作废了，删除之。</p>
<h2>2012-10-7</h2>
<p>Label部件的源代码已经修改，原有的彩色文本渲染代码已经删除，改用新增的文本位图处理功能，该功能之前是写在TextBox部件的代码里的，后来分离出来了。</p>
<p>具体修改内容可<a href="https://github.com/lc-soft/LCUI/commit/e64623f55b0862c50930bbbb8b93012214f807ce" target="_blank">查看这里</a>。</p>
<p>在修改Label部件的源代码的过程中，也纠正了文本位图处理功能上的一些问题。</p>
<p>&nbsp;</p>
<p>&nbsp;</p>
<h2> 2012-10-8 至 2012-10-13</h2>
<p>由于blog.lcui.org无法访问，没有该段时间记录的日志，只备份了10月7日的日志，还好之前sourceforge.net上还有我搭建的wordpress，FTP上传导入工具插件，启用插件后，在上面恢复了这个备份。</p>
<p>各种图片在本地上有备份，博客无法使用对我没多大的影响。</p>
<p>github上也建了个主页。</p>
<p>这段时间内只是研究了高斯模糊算法，这是处理前的图像：</p>
<p><a href="http://www.lcui.org/files/images/devlog/gaussian_blur_before.png"><img class="alignnone" title="高斯模糊处理前" src="http://www.lcui.org/files/images/devlog/gaussian_blur_before.png" alt="" width="256" height="256" ></a></p>
<p>sigma 设为 20，高斯模糊处理后：</p>
<p><a href="http://www.lcui.org/files/images/devlog/gaussian_blur_after.png"><img class="alignnone" title="高斯模糊处理后" src="http://www.lcui.org/files/images/devlog/gaussian_blur_after.png" alt="" width="256" height="256" ></a></p>
<p>Label部件 和 文本图层的处理做了修改，具体可到github上查看代码提交记录。</p>
<h2> 2012-10-14</h2>
<p>为了保险起见，已在项目主页上添加开发日志的静态html页面，主页也随之做了些修改。</p>
<p>项目主页的音乐播放器中的音乐列表做了修改。</p>
<h2>2012-10-15</h2>
<p>正准备添加滚动条。</p>
<p>文本图层的部分字体位图绘制不完全，少了一行像素，如下图所示，“/* 最经典的C语言代”这行文本位图少了一行像素。</p>
<p><a href="http://www.lcui.org/files/images/devlog/2012-10-15-17-26-45.png"><img class="alignnone" title="截图" src="http://www.lcui.org/files/images/devlog/2012-10-15-17-26-45.png" alt="" width="320" height="240" ></a></p>
<h2>2012-10-16</h2>
<p>由于在绘制字体位图前，需要将能容纳该字体的最大区域的alpha通道填充为0，导致之前绘制的上一行文本位图的最后一行像素被填充掉了。该最大区域的尺寸，只是用当前 字体像素+2 得出的，是一个正方形。</p>
<p>修改一下，在文字改变或大小改变时，将当前文字所在区域添加至队列，等待将这些区域的alpha通道填充为0.</p>
<p>又发现一个问题，由4改变至其它窄一些的字后，会留有残余图形；调试时，打印的信息表明有些变量未赋初始值，字体位图转移后，又初始化源字体位图，尺寸为0，导致坐标计算错误，添加了错误的刷新区域；修改的代码<a href="https://github.com/lc-soft/LCUI/commit/345e0bf80cf4933569343b14ecbdddf6b9d68c96#L3R882" target="_blank">可到这查看</a>。</p>
<p>源文件的编码是GB2312.，转换成了UTF-8.</p>
<p>发现不能连续换多行，用了几个换行符 \n  ，也只换一行。</p>
<p>OK，已完成，在调用TextLayer_Text_Add_NewRow()函数更新每一行尺寸时，初始最大高度为当前文本风格设定的字体尺寸+2；</p>
<p><a href="http://www.lcui.org/files/images/devlog/2012-10-16-21-50-27.png"><img class="alignnone" title="连续换行" src="http://www.lcui.org/files/images/devlog/2012-10-16-21-50-27.png" alt="" width="320" height="240" ></a></p>
<p>&nbsp;</p>
<h2>2012-10-17</h2>
<p>纠结滚动条的设计，能够设置滚动条是纵向还是横向，是纵向的话，高度与容器高度一致，横向的话，宽度与容器宽度一致，但是，怎么实现呢？貌似需要添加一些属性。</p>
<p>另外，要设计一个函数，这个函数能够添加指定容器内的部件，使滚动条在移动时，该容器内的部件能够一同移动；但是，若容器内有多个滚动条，移动时，哪个滚动条该被移动？各种纠结，不知如何用语言描述纠结的问题。</p>
<h2>2012-10-18</h2>
<p>部件的尺寸、位置可以用浮点数，限制尺寸可以只限制宽或高，当使用浮点数时，尺寸和位置需根据容器的尺寸x浮点数确定，这个浮点数其实是代表百分比，该设计参考了html元素的css属性，比如div元素，width=50px是宽为50像素，width=50%那就是宽为容器宽度的一半。<br >
其实，C++的重载函数蛮有用的，假设要设定部件尺寸，有这么些尺寸：<br >
宽为100px，高为80%<br >
宽为50%，高为100%<br >
宽高都为100px<br >
宽高都为100%<br >
用C的话，函数名要4个，用C++的话，可用同名函数，参数类型可以不一样。<br >
好吧，参数都用字符串，处理是判断字符内容即可。</p>
<p>部件数据结构需要修改，分为两类成员：<br >
基本属性，比如已经计算出的坐标位置、尺寸。<br >
附加属性，比如：位置限制范围，尺寸限制范围，这些属性影响基本属性，因为有的是描述性的，尤其是使用百分比，需要经过计算。</p>
<p>添加一个结构体，用于同时存储整型和浮点型数据，类型名定为：comb_t ，也就是复合类型。</p>
<p>部件的属性，还是参考QT、VC的设计。</p>
<p>添加属性：auto_size_mode，用于指定部件的自动尺寸调整的模式，有两个值：grow_only（只增加）和grow_and_shrink（增加和缩小）。</p>
<p>添加属性：Dock，用于指定部件的停靠位置，有上、下、左、右、填充、无。</p>
<h2>2012-10-21</h2>
<p>LCUI_Widget结构体已经修改完毕，相关函数的代码也已修改完毕，修改过程中所产生的BUG已被处理。</p>
<p>开始实现文本图层的缺省文本样式设置。</p>
<p>已基本完成，效果图如下：</p>
<p><a href="http://www.lcui.org/files/images/devlog/2012-10-21-17-52-51.png"><img class="alignnone" title="Label部件的BUG" src="http://www.lcui.org/files/images/devlog/2012-10-21-17-52-51.png" alt="" width="320" height="240" /></a></p>
<p>缺省字体大小设置为20像素，没设置颜色的文本的大小是12像素，而彩色文本的大小却是20像素。</p>
<p>处理效果还不错，即使是不同大小的字体，排列得也比较整齐，看来，可以加入&lt;size&gt;标签的支持。</p>
<p><a href="https://github.com/lc-soft/LCUI/commit/5d595f2663189049173c2ac4a4c9c2b0c53743c8" target="_blank">combo_t更名为PX_P_t，新增PX_PT_t类型</a>；PX是pixel，P是percent，也就是用于表示像素数或百分比，部件的位置和尺寸可以用具体像素数或百分比表示。PX_PT_t类型用于表示字体大小，因为字体大小单位有两个：像素 和 点数。</p>
<p><a href="https://github.com/lc-soft/LCUI/commit/8406ad178d78f49a11817acc43e5c6d8b950f554" target="_blank">已经添加&lt;size&gt;标签的支持</a>，可以用该标签设定指定段文本的字体大小，效果如图所示：</p>
<p><a href="http://www.lcui.org/files/images/devlog/2012-10-21-20-46-55.png"><img class="alignnone" title="字体粘贴位置有小问题" src="http://www.lcui.org/files/images/devlog/2012-10-21-20-46-55.png" alt="" width="320" height="240" /></a></p>
<p>字体位置还有点小问题。</p>
<p><a href="https://github.com/lc-soft/LCUI/commit/b088c56b3c287b8c3a56288432ab49507599882e" target="_blank">调整了字体位图粘贴位置</a>，之前是根据当前字体大小最大高度（当前像素+2）计算的，现在改为根据当前文本行最大高度来计算，最终效果图如下所示：</p>
<p><a href="http://www.lcui.org/files/images/devlog/2012-10-21-21-00-42.png"><img class="alignnone" title="正常效果" src="http://www.lcui.org/files/images/devlog/2012-10-21-21-00-42.png" alt="" width="320" height="240" /></a></p>
<p>&nbsp;</p>
<h2> 2012-10-22</h2>
<p>开始实现部件的dock属性，还有以百分比为单位的部件尺寸的处理。</p>
<p>在测试dock属性时，发现下划线 ‘_’ 没有显示出来，切换几个dock属性后程序崩溃。</p>
<p>调试结果表明，是图像引用出现问题，引用区域不在图像的有效范围内，<a href="https://github.com/lc-soft/LCUI/commit/ad45a5d10cc35b01a9c9b8cce9fd047df5bae99a" target="_blank">现在已经纠正</a>。</p>
<p>打印了下划线 ‘_’的位图信息，发现它的top值为-1，怪不得没有在区域内绘制，因为最大高度减去 -1，已经超出这个区域了，解决方法就是改成：<a href="https://github.com/lc-soft/LCUI/commit/6503e198cae60dfb5a359b5eb37b07e6a3830748" target="_blank">最大高度-1 &#8211; top</a>。</p>
<p><a href="https://github.com/lc-soft/LCUI/commit/927e9fa7ffda70299ae921c96ed9385b7e61b80a#L4R1" target="_blank">测试程序已经添加</a>，效果如下图所示：</p>
<p><img class="alignnone" title="测试widget的dock属性" src="http://www.lcui.org/files/images/devlog/test_widget_dock.gif" alt="" width="320" height="240" /></p>
<p>计划添加padding和margin属性的处理。</p>
<h2>2012-10-23</h2>
<p>想将wordpress上的评论同步到静态html网页，合并同一文章的评论，可出了些问题，本以为导出的数据可以再导入，于是就将评论数据清空，而 多说 评论的导入工具暂时不能用，这就悲剧了，只好等开发者完善。</p>
<p>发现一个BUG，拖动窗口到屏幕边缘时，卡住了。</p>
<h2>2012-10-24</h2>
<p>只能怀疑问题出在最近修改的代码里，最有可能的就是与图形处理 + 区域计算 相关的函数。</p>
<p>原来是Quote_Graph函数的问题，由于在判断区域为无效后，没有用return退出函数，结果又执行了 引用区域有效时 所做的操作，<a href="https://github.com/lc-soft/LCUI/commit/507fd5929562ccf9a3f5edea595f86c12720bb07#L0R482" target="_blank">现已解决</a>。</p>
<p>开始实现部件的定位类型处理功能，和css的postion属性类似，有absolute, fixed, relative, static这些值。</p>
<p>fixed，可以有这么个效果：一个窗口里嵌套个子部件，子部件的定位类型为fixed，拖动这个窗口，子部件不会跟着窗口移动，位置还是屏幕上的绝对位置。</p>
<p>absolute，部件的位置默认就是相对于父部件的，而&#8221;left&#8221;, &#8220;top&#8221;, &#8220;right&#8221; 以及 &#8220;bottom&#8221; 这四个属性，可以通过设置部件的Pos，或者设置Anlign外加offset，以实现这四个属性的效果，部件就不用添加这四个属性。</p>
<p>relative，舍去，直接使用static定位类型，然后设置offset即可。位置还是原来的位置，但显示时，如果有几个部件挨着它，它就会覆盖到别的部件。</p>
<p>static，部件位置由LCUI决定，同属这个定位类型的部件，不会叠加在一起，只会挨个挤在一起。</p>
<p>&nbsp;</p>
<h2>2012-10-25</h2>
<p>查看了与CSS的postion属性相关文章，还是添加relative定位，static定位则不受pos，align，offset的影响，完全由LCUI决定位置布局；而relative定位只是static的支持offset的版本。</p>
<p>看了下面这张图，发现relative定位的区块都是显示在static定位的区块之上，看来处理部件的堆叠顺序时还需要分组，先处理static定位的部件的显示，再处理其他定位的部件的显示。</p>
<p><a href="http://pic-server2.byywee.com/M0/S678/678814-0.jpg"><img class="alignnone" title="relative与static" src="http://pic-server2.byywee.com/M0/S678/678814-0.jpg" alt="" width="473" height="367" /></a></p>
<p>需要纠结定位类型为static的部件的位置处理，具体可看下图：</p>
<p><a href="http://www.lcui.org/files/images/devlog/block_layout.png"><img class="alignnone" title="区块布局处理" src="http://www.lcui.org/files/images/devlog/block_layout.png" alt="" width="576" height="370" /></a></p>
<p>该用怎样的算法实现以上的部件布局呢？</p>
<h2> 2012-10-26</h2>
<p>先把上图所示的部件布局处理流程写下来，毕竟存在脑子里也不好思考。</p>
<p>添加区块A，位置为（0，0），没有重叠其它区块，位置更新完成。<br />
添加区块B，位置为（0，0），与区块A重叠；X轴坐标加上区块A的宽度，位置为（A.w, 0），无重叠区块，位置更新完成。<br />
添加区块C，位置为（0，0），与区块A重叠；X轴坐标加上区块A的宽度，位置为（A.w, 0），与区块B重叠；X轴坐标加上区块A的宽度，位置为（A.w+B.w, 0），无重叠区域，位置更新完成。<br />
添加区块D，位置为（0，0），与区块A重叠；X轴坐标加上区块A的宽度，位置为（A.w, 0），与区块B重叠；X轴坐标加上区块A的宽度，位置为（A.w+B.w, 0），与区块C重叠；X轴坐标加上区块C的宽度，坐标为（A.w+B.w+C.w, 0）,区块D超过容器范围；</p>
<p>将区块ABC的区域数据记录到队列中，从队列中获取第一个区域数据（也就是A），Y轴坐标加上区块A的高度，区块D的位置为（0，A.h），无重叠区域，位置更新完成。</p>
<p>添加区块E，重复区块D的操作；区块E的位置为（0，A.h），与区块D重叠，X轴坐标加上区块D的宽度，位置为：（D.w，A.h）；无重叠区块，位置更新完成。</p>
<p>添加区块F，重复区块E的操作；区块F的位置为（D.w+E.w，A.h），由于区块F与区块C和B在X轴上有重叠，又因为区块C的高度大于B，因此区块F的位置为（D.w+E.w，C.h）；无重叠区块，位置更新完成。</p>
<p>添加区块G，重复区块F的操作，区块G超出容器范围，将区块DEFC的区域数据记录到队列中，从队列中获取第一个区域数据（也就是D），Y轴坐标加上区块D的高度，区块G的位置为（0，D.x+D.h），超出容器范围；X轴坐标加上区块D的宽度，位置为（D.w, D.y+D.h）；与区块E重叠，增加Y轴坐标到区块E的高度，区块G的位置为（D.w，E.y+E.h）；超出容器范围；X轴坐标加上区块E的宽度，位置为（D.w+E.w，E.y+E.h）；由于区块G与区块E在X轴上没有重叠关系，与区块F有重叠关系，更改Y轴坐标，位置为（D.w+E.w，F.y+F.h）；无重叠区块，在容器范围内，位置更新完成。</p>
<p>个人觉得实现这个功能的函数，应该是用于处理一个容器内所有定位类型为static的部件，一次性将这些部件的位置更新掉；如果只用于更新一个部件，那么，效率低下，部件越多，重复的操作也越多。</p>
<p>在写这处理过程时发现，队列中只需要保存外围区块的区域信息即可，更新新部件的位置时，只需要将它与队列中记录的区域对比，即可算出适合的位置；但如何得出外围区块的区域数据，需要思考。</p>
<p>新的算法：</p>
<p>用一个二维指针（假设为ptr），作为一个表，用X和Y变量，表示记录点的位置。</p>
<p>按照显示顺序遍历部件队列，每遍历到一个部件，就把部件指针记录到记录点，更新部件位置，并使X++，当当前部件区块超出容器范围时，Y++，开始记录下一行。</p>
<p>如果有上一行记录，那么，就将当前部件区块与上一行的对比，只对比X轴坐标，如果当前部件区块的X轴占用区域与上一行的若干个部件区块重叠，那么，记录这些部件；当前部件区块的Y轴坐标就会根据那几个部件区块来调整，从左至右，当有个Y轴坐标能够不与上一行其它区块重叠时，那么该区块的位置就更新完毕。</p>
<p>举个例子，当前部件区块如上图中的区块E，在X轴上，它与区块A（ptr[0][0]）和区块B（ptr[0][1]）重叠，先让区块E的Y轴坐标为A.y+A.h，由于区块E使用这个坐标后，不与区块B（ptr[0][1]）重叠，所以区块E的位置更新完毕。</p>
<p>而X坐标是随着部件位置的更新而更新，在更新区块E时，X坐标就已经到了D.x+D.w。</p>
<h2> 2012-10-27</h2>
<p>若要实现下图所示的部件布局效果，该怎么实现？</p>
<p><a href="http://www.lcui.org/files/images/devlog/block_layout2.png"><img class="alignnone" title="部件区块布局处理-2" src="http://www.lcui.org/files/images/devlog/block_layout2.png" alt="" width="576" height="370" /></a></p>
<p>对于B、E这种高度较高的区块，其它区块该怎样确定好位置？</p>
<p>拿区块M举例，更新完L的位置后，要更新区块M的位置，区块M是应该在灰色M那个区块，还是应该在蓝色M区块？</p>
<p>如果要放在灰色M区块，按照之前的方法还是可以实现的。</p>
<p>还有那个区块H，按照之前的方法，区块H会在区块J的位置，那么，加个处理：</p>
<p>如果当前区块底边的y轴坐标小于上一行区块的底边y轴坐标，那么，就将上一行区块再记录到当前行，因为它的高度足以占用两行（或以上）的区块区域。</p>
<p>但还是觉得会浪费空间，如果区块B底边的y轴坐标小于当前区块底边的y轴坐标几个像素，按照之前的方法，它当前区块的y轴坐标就等于区块B底边的y轴坐标+1，这样看起来，区块C到H之间，有一块比较大的空区域，若要节省些空区域，还是调整一下，判断条件改为：B.y+B.h &gt; (H.y+H.h)/2.0 ，也就是判断区块B的底边是否超过区块H的一半，这应该好一点了。</p>
</div>

<!-- Duoshuo Comment BEGIN --> 
	<a id="blog-comment"></a>
	<div class="ds-thread" data-thread-key="7" data-title="LCUI 0.12.6" data-category="LCUI-Dev"  data-url="http://www.lcui.org/zh-cn/devlog-lcui-0.12.6.html"></div>
<!-- Duoshuo Comment END -->

    <!-- 网页底部的内容 -->
    <hr>
    <table class="my_style" width="100%">
      <tr>
        <td align="left">
          网页由
          <a href="mailto:lc-soft@live.cn">
            刘超
          </a>
          维护
        </td> 
        <td align="right">
          <a target="_blank" href="http://validator.w3.org/check/referer">
            <img border=0 src="http://www.w3.org/Icons/valid-html401-blue" alt="Valid HTML 4.0!"
            height=31 width=88>
          </a>
        </td>
      </tr>
      <tr>
        <td>
          最后更新: 2012-10-27
        </td> 
        <td align="right">
		<a target="_blank" href="http://sighttp.qq.com/authd?IDKEY=af7bcac3a71b6cf237e715c4f3beffc6e53bdf1075cb4674">
		  <img border="0" src="http://wpa.qq.com/imgd?IDKEY=af7bcac3a71b6cf237e715c4f3beffc6e53bdf1075cb4674&amp;pic=45" alt="通过QQ与作者进行交流" title="通过QQ与作者进行交流"></a>
          <script type="text/javascript" src="../files/js/baidu-code.js">
          </script>
		  <script src="http://s23.cnzz.com/stat.php?id=4262888&amp;web_id=4262888&amp;show=pic1" type="text/javascript"></script>
        </td>
      </tr>
    </table>
  </div>
  </body>



</html>
<!-- page-front.tpl -->
